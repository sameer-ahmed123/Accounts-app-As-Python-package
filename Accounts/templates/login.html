<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login Page</title>

</head>

<body>
    <h1>login page for Accounts app</h1>

    <a href="{% url 'accounts:login' %}">appname link</a>

    <div class="login_box">
        <form action="" method="post" id="login_form">
            {% csrf_token %}
            {{form.as_p}}
            <input id="login_submit" type="submit">
        </form>

        <div id="disp">

        </div>
    </div>

        <script src="https://code.jquery.com/jquery-3.6.4.min.js"
            integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script>

        const disp = document.getElementById("disp")
        $(document).on('submit', '#login_form', function (e) {
            e.preventDefault();
            var username = $("#id_username").val()
            var password = $("#id_password").val()
            $.ajax({
                type: 'POST',
                url: '{% url "accounts:login" %}',
                data: {
                    'username': username,
                    'password': password,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    action: 'post'
                },
                success: function (response) {
                    console.log(response.status)
                    console.log("ajax login working")
                    $("#error_message").text(response.status)
                    if (response.status == "authenticated") {
                        $("#error_message").text(response.status);
                        disp.innerHTML = "login success";
                        // here after the post ajax request succeeds it send
                        // another get request to get the required page 
                        $.ajax({
                            url: "{% url 'accounts:chk' %}",
                            type: "GET",
                            success: function (data) {
                                // Replace the current page content with the fetched content
                                $("html").html(data);
                                // Update the URL without reloading the page
                                window.history.pushState({}, "", "{% url 'accounts:chk' %}");
                            },
                            error: function (xhr, errmsg, err) {
                                console.error(xhr, errmsg, err);
                            },
                        });
                    }
                    else {
                        disp.innerHTML = response.status
                    }
                },
                error: function (xhr, errmsg, err) {
                    console.error(xhr, errmsg, err)
                },
            })
        });

    </script>

</body>

</html>